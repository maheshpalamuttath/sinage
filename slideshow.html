<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Digital Signage</title>
<style>
  html, body { margin: 0; padding: 0; width: 100%; height: 100%; background: black; overflow: hidden; }
  #container { width: 100%; height: 100%; position: relative; }

  img, video, iframe {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      top: 0; left: 0;
      transform: translateX(100%);
      transition: transform 1s ease-in-out;
      border: none;
  }

  img.show, video.show, iframe.show {
      transform: translateX(0);
  }

  img.prev, video.prev, iframe.prev {
      transform: translateX(-100%);
  }
</style>
</head>
<body>
<div id="container"></div>

<script>
async function loadMedia() {
    const mediaSlides = [];

    // URLs first
    const resUrls = await fetch('/urls');
    const urls = await resUrls.json();
    urls.forEach(url => {
        const iframe = document.createElement('iframe');
        iframe.src = url;
        mediaSlides.push({ type: 'url', element: iframe });
    });

    // Images next
    const resFiles = await fetch('/files');
    const files = await resFiles.json();
    files.forEach(f => {
        const ext = f.split('.').pop().toLowerCase();
        if(['png','jpg','jpeg','gif'].includes(ext)){
            const img = document.createElement('img');
            img.src = `/media/${f}`;
            mediaSlides.push({ type: 'image', element: img });
        }
    });

    // Videos last
    files.forEach(f => {
        const ext = f.split('.').pop().toLowerCase();
        if(ext === 'mp4'){
            const video = document.createElement('video');
            video.src = `/media/${f}`;
            video.autoplay = false;
            video.loop = false;
            video.muted = true;
            video.preload = 'auto';
            mediaSlides.push({ type: 'video', element: video });
        }
    });

    return mediaSlides;
}

async function startSlideshow() {
    const container = document.getElementById('container');
    const slides = await loadMedia();
    let index = 0;
    let prevIndex = slides.length - 1;

    slides.forEach(slide => container.appendChild(slide.element));

    function showNext() {
        const current = slides[index];
        const prev = slides[prevIndex];

        // Slide previous out to left
        prev.element.classList.remove('show');
        prev.element.classList.add('prev');

        // Slide current in from right
        current.element.classList.remove('prev');
        current.element.classList.add('show');

        if(current.type === 'video') {
            current.element.currentTime = 0;
            current.element.play();
            current.element.onended = () => {
                prevIndex = index;
                index = (index + 1) % slides.length;
                showNext();
            };
        } else {
            setTimeout(() => {
                prevIndex = index;
                index = (index + 1) % slides.length;
                showNext();
            }, 15000);
        }
    }

    showNext();
}

startSlideshow();

// Auto-refresh page every 60s to pick up new files/URLs
setInterval(() => location.reload(), 120000);
</script>
</body>
</html>
